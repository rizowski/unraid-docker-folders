Menu="Docker"
Title=""
Tag=""
Cond="is_file('/var/run/dockerd.pid')"
Markdown="false"
---
<?php
require_once '/usr/local/emhttp/plugins/unraid-docker-folders-modern/include/config.php';
require_once '/usr/local/emhttp/plugins/unraid-docker-folders-modern/classes/Database.php';

$db = Database::getInstance();
$row = $db->fetchOne('SELECT value FROM settings WHERE key = ?', ['replace_docker_section']);
$replaceDockersSection = ($row && $row['value'] === '1');

if (!$replaceDockersSection) return;
?>

<link rel="stylesheet" href="<?autov('/plugins/unraid-docker-folders-modern/assets/css/app.css')?>">

<script>
(function() {
  function tryReplace() {
    // Strategy: find the Docker Containers section and replace it entirely.
    // Unraid's Docker page uses a table-based layout. The containers section
    // is typically a <table> with an id or a recognizable heading inside it.

    var containerSection = null;

    // 1. Try known IDs/selectors
    var selectors = [
      '#docker_containers',
      'table.docker_readmore',
      '#dockerContainerTable',
    ];
    for (var i = 0; i < selectors.length; i++) {
      containerSection = document.querySelector(selectors[i]);
      if (containerSection) break;
    }

    // 2. Fallback: find by "Docker Containers" heading text
    if (!containerSection) {
      var allElements = document.querySelectorAll('td, th, h2, h3, div.title, span.title');
      for (var j = 0; j < allElements.length; j++) {
        var text = allElements[j].textContent || '';
        if (text.trim().match(/^Docker Containers$/i)) {
          // Walk up to the outermost containing table/section
          containerSection = allElements[j].closest('table') || allElements[j].closest('div') || allElements[j].parentElement;
          break;
        }
      }
    }

    if (!containerSection) {
      if (tryReplace.attempts < 20) {
        tryReplace.attempts++;
        setTimeout(tryReplace, 250);
      }
      return;
    }

    // Walk up: if the section is inside a wrapper that only contains this section,
    // replace at the highest useful level to avoid empty containers
    var target = containerSection;
    while (target.parentElement) {
      var parent = target.parentElement;
      // Stop at body or at content_all / tab containers â€” those are page-level
      if (parent === document.body || parent.id === 'content_all' || parent.id === 'tab1' ||
          parent.classList.contains('content') || parent.tagName === 'FORM') break;
      // If parent has only this child (or only whitespace text nodes), go up
      var siblings = Array.from(parent.childNodes).filter(function(n) {
        return n.nodeType === 1 || (n.nodeType === 3 && n.textContent.trim());
      });
      if (siblings.length === 1) {
        target = parent;
      } else {
        break;
      }
    }

    // Replace the target's content with our app
    target.innerHTML = '';
    target.style.padding = '0';
    target.style.margin = '0';
    target.style.border = 'none';
    target.style.background = 'none';

    var wrapper = document.createElement('div');
    wrapper.id = 'unraid-docker-folders-modern';
    wrapper.className = 'unapi';

    var appDiv = document.createElement('div');
    appDiv.id = 'app';
    wrapper.appendChild(appDiv);
    target.appendChild(wrapper);

    // Hide any sibling elements that are part of the containers UI
    // (e.g. "Add Container" button, context menus, footers)
    var siblingsToHide = ['#btnAddContainer', '.addContainer', '#dockerMenu',
                          '#docker-context-menu', '.docker_readmore'];
    siblingsToHide.forEach(function(sel) {
      var el = document.querySelector(sel);
      if (el && !target.contains(el)) {
        el.style.display = 'none';
      }
    });

    // Load our app
    var script = document.createElement('script');
    script.type = 'module';
    script.src = '/plugins/unraid-docker-folders-modern/assets/js/app.js';
    document.body.appendChild(script);
  }

  tryReplace.attempts = 0;

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', tryReplace);
  } else {
    setTimeout(tryReplace, 100);
  }
})();
</script>
