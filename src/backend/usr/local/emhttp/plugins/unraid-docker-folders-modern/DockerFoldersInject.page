Menu="Docker"
Title=""
Tag=""
Cond="is_file('/var/run/dockerd.pid')"
Markdown="false"
---
<?php
require_once '/usr/local/emhttp/plugins/unraid-docker-folders-modern/include/config.php';
require_once '/usr/local/emhttp/plugins/unraid-docker-folders-modern/classes/Database.php';

$db = Database::getInstance();
$row = $db->fetchOne('SELECT value FROM settings WHERE key = ?', ['replace_docker_section']);
$replaceDockersSection = ($row && $row['value'] === '1');

if (!$replaceDockersSection) return;
?>

<link rel="stylesheet" href="<?autov('/plugins/unraid-docker-folders-modern/assets/css/app.css')?>">

<script>
(function() {
  function tryReplace() {
    var containerSection = null;

    // 1. Primary: look for the container list table by known IDs
    var selectors = [
      '#docker_list',
      '#docker_containers',
      'table.docker_readmore',
      '#dockerContainerTable',
    ];
    for (var i = 0; i < selectors.length; i++) {
      containerSection = document.querySelector(selectors[i]);
      if (containerSection) break;
    }

    // 2. Try finding rows with ct-name class (container name cells)
    if (!containerSection) {
      var ctName = document.querySelector('.ct-name');
      if (ctName) {
        containerSection = ctName.closest('table') || ctName.closest('div');
      }
    }

    // 3. Fallback: find by "Docker Containers" heading text
    if (!containerSection) {
      var allElements = document.querySelectorAll('td, th, h2, h3, div.title, span.title, div > span');
      for (var j = 0; j < allElements.length; j++) {
        var text = (allElements[j].textContent || '').trim();
        if (/^Docker Containers$/i.test(text)) {
          containerSection = allElements[j].closest('table') || allElements[j].closest('div') || allElements[j].parentElement;
          break;
        }
      }
    }

    if (!containerSection) {
      if (tryReplace.attempts < 20) {
        tryReplace.attempts++;
        setTimeout(tryReplace, 250);
      }
      return;
    }

    // Walk up: if the section is inside a wrapper that only contains this section,
    // replace at the highest useful level to avoid empty containers
    var target = containerSection;
    while (target.parentElement) {
      var parent = target.parentElement;
      // Stop at body or at content_all / tab containers — those are page-level
      if (parent === document.body || parent.id === 'content_all' || parent.id === 'tab1' ||
          parent.classList.contains('content') || parent.tagName === 'FORM') break;
      // If parent has only this child (or only whitespace text nodes), go up
      var siblings = Array.from(parent.childNodes).filter(function(n) {
        return n.nodeType === 1 || (n.nodeType === 3 && n.textContent.trim());
      });
      if (siblings.length === 1) {
        target = parent;
      } else {
        break;
      }
    }

    // Hide native container section instead of clearing it —
    // Unraid renders its container list asynchronously and would overwrite innerHTML
    target.style.display = 'none';

    // Insert our app as a sibling before the hidden target
    var wrapper = document.createElement('div');
    wrapper.id = 'unraid-docker-folders-modern';
    wrapper.className = 'unapi';

    var appDiv = document.createElement('div');
    appDiv.id = 'app';
    wrapper.appendChild(appDiv);
    target.parentElement.insertBefore(wrapper, target);

    // Keep native UI hidden even if Unraid re-renders or modifies the DOM
    var nativeSelectors = selectors.concat(['.ct-name']);
    var parentEl = target.parentElement;

    function hideNativeElements() {
      // Re-hide target in case Unraid toggled its display
      if (target.style.display !== 'none') {
        target.style.display = 'none';
      }
      // Hide any new native container elements that appear outside our wrapper
      nativeSelectors.forEach(function(sel) {
        parentEl.querySelectorAll(sel).forEach(function(el) {
          if (wrapper.contains(el)) return;
          // Walk up to find the direct child of parentEl
          var ancestor = el;
          while (ancestor.parentElement && ancestor.parentElement !== parentEl) {
            ancestor = ancestor.parentElement;
          }
          if (ancestor !== wrapper && ancestor !== target && ancestor.parentElement === parentEl) {
            ancestor.style.display = 'none';
          }
        });
      });
    }

    var observer = new MutationObserver(function() {
      hideNativeElements();
    });
    observer.observe(parentEl, { childList: true, subtree: true });

    // Hide any sibling elements that are part of the containers UI
    var siblingsToHide = ['#btnAddContainer', '.addContainer', '#dockerMenu',
                          '#docker-context-menu', '.docker_readmore'];
    siblingsToHide.forEach(function(sel) {
      var el = document.querySelector(sel);
      if (el && !wrapper.contains(el)) {
        el.style.display = 'none';
      }
    });

    // Hide the "Folders" tab link since our app is embedded here
    var tabLinks = document.querySelectorAll('#tab-bar a, .tabs a, ul.tabs li a, a[href*="DockerFolders"]');
    tabLinks.forEach(function(link) {
      var linkText = (link.textContent || '').trim();
      if (linkText === 'Folders' || /DockerFoldersMain/i.test(link.href || '')) {
        link.style.display = 'none';
      }
    });

    // Load our app
    var script = document.createElement('script');
    script.type = 'module';
    script.src = '/plugins/unraid-docker-folders-modern/assets/js/app.js';
    document.body.appendChild(script);
  }

  tryReplace.attempts = 0;

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', tryReplace);
  } else {
    setTimeout(tryReplace, 100);
  }
})();
</script>
