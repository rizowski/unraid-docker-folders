Menu="Utilities"
Title="Docker Folders Modern"
Icon="icon.png"
Tag="folder"
Markdown="false"
---
<?php
require_once '/usr/local/emhttp/plugins/unraid-docker-folders-modern/include/config.php';
require_once '/usr/local/emhttp/plugins/unraid-docker-folders-modern/classes/Database.php';

$db = Database::getInstance();
$rows = $db->fetchAll('SELECT key, value FROM settings');
$settings = [];
foreach ($rows as $row) {
  $settings[$row['key']] = $row['value'];
}
$distinguishHealthy = ($settings['distinguish_healthy'] ?? '1') === '1';
$showStats = ($settings['show_stats'] ?? '1') === '1';
$replaceDockerSection = ($settings['replace_docker_section'] ?? '0') === '1';
$showFolderPorts = ($settings['show_folder_ports'] ?? '1') === '1';

// Parse CHANGELOG.md — extract the latest version section
$changelogHtml = '';
$changelogPath = PLUGIN_DIR . '/CHANGELOG.md';
if (file_exists($changelogPath)) {
  $lines = file($changelogPath, FILE_IGNORE_NEW_LINES);
  $inLatest = false;
  $sections = [];
  $currentSection = '';
  $currentItems = [];

  foreach ($lines as $line) {
    // Skip the "# Changelog" title
    if (preg_match('/^# /', $line)) continue;

    // "## version" — start of a version block
    if (preg_match('/^## (.+)/', $line, $m)) {
      if ($inLatest) break; // stop at second version heading
      $inLatest = true;
      $changelogVersion = trim($m[1]);
      continue;
    }

    if (!$inLatest) continue;

    // "### Section" heading
    if (preg_match('/^### (.+)/', $line, $m)) {
      if ($currentSection && $currentItems) {
        $sections[] = ['title' => $currentSection, 'items' => $currentItems];
      }
      $currentSection = trim($m[1]);
      $currentItems = [];
      continue;
    }

    // "- item" list entry
    if (preg_match('/^- (.+)/', $line, $m)) {
      $currentItems[] = htmlspecialchars(trim($m[1]));
    }
  }

  if ($currentSection && $currentItems) {
    $sections[] = ['title' => $currentSection, 'items' => $currentItems];
  }

  if ($sections) {
    $changelogHtml .= '<h3 style="margin:0 0 10px 0;font-size:16px;color:#333;">Latest Changes — ' . htmlspecialchars($changelogVersion ?? '') . '</h3>';
    foreach ($sections as $sec) {
      $changelogHtml .= '<p style="margin:8px 0 4px;font-weight:600;font-size:13px;color:#555;">' . htmlspecialchars($sec['title']) . '</p><ul style="margin:0 0 0 16px;padding:0;font-size:13px;color:#666;">';
      foreach ($sec['items'] as $item) {
        $changelogHtml .= '<li style="margin:2px 0;">' . $item . '</li>';
      }
      $changelogHtml .= '</ul>';
    }
  }
}
?>

<style>
.settings-container {
  max-width: 800px;
  margin: 20px auto;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.settings-header {
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid #e0e0e0;
}

.settings-header h1 {
  margin: 0 0 10px 0;
  font-size: 28px;
  color: #333;
}

.settings-header p {
  margin: 0;
  color: #666;
  font-size: 14px;
}

.info-box {
  background: #f5f5f5;
  border-left: 4px solid #2196f3;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 4px;
}

.info-box h3 {
  margin: 0 0 10px 0;
  font-size: 16px;
  color: #333;
}

.info-box p {
  margin: 5px 0;
  font-size: 14px;
  color: #666;
}

.info-box code {
  background: white;
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
}

.settings-section {
  background: #f5f5f5;
  border-left: 4px solid #4caf50;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 4px;
}

.settings-section h3 {
  margin: 0 0 15px 0;
  font-size: 16px;
  color: #333;
}

.setting-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid #e0e0e0;
}

.setting-row:last-child {
  border-bottom: none;
}

.setting-info {
  flex: 1;
}

.setting-info label {
  display: block;
  font-weight: 500;
  font-size: 14px;
  color: #333;
  cursor: pointer;
}

.setting-info .description {
  font-size: 12px;
  color: #888;
  margin-top: 2px;
}

.setting-control {
  margin-left: 20px;
}

.setting-control input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.save-status {
  font-size: 12px;
  color: #4caf50;
  margin-left: 8px;
  opacity: 0;
  transition: opacity 0.3s;
}

.save-status.visible {
  opacity: 1;
}

.action-buttons {
  margin-top: 20px;
  display: flex;
  gap: 10px;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  text-decoration: none;
  display: inline-block;
}

.btn-primary {
  background: #2196f3;
  color: white;
}

.btn-primary:hover {
  background: #1976d2;
}

.btn-secondary {
  background: #e0e0e0;
  color: #333;
}

.btn-secondary:hover {
  background: #d0d0d0;
}
</style>

<div class="settings-container">
  <div class="settings-header">
    <h1>Docker Folders</h1>
    <p>A modern plugin for organizing Docker containers with folders and real-time updates</p>
    <div style="margin-top: 12px;">
      <a href="/Docker" class="btn btn-primary">Open Docker Folders</a>
    </div>
  </div>

  <div class="info-box">
    <h3>Plugin Information</h3>
    <p><strong>Version:</strong> <?= PLUGIN_VERSION ?></p>
    <p><strong>Author:</strong> <?= PLUGIN_AUTHOR ?></p>
  </div>

  <?php if ($changelogHtml): ?>
  <div class="info-box" style="border-left-color: #4caf50;">
    <?= $changelogHtml ?>
  </div>
  <?php endif; ?>

  <div class="settings-section">
    <h3>Display Settings</h3>

    <div class="setting-row">
      <div class="setting-info">
        <label for="replace-docker-section">Replace Docker Containers section</label>
        <div class="description">When enabled, the built-in Docker Containers section on the Docker tab is replaced with the Docker Folders UI. <strong>Default: Off</strong></div>
      </div>
      <div class="setting-control">
        <input type="checkbox" id="replace-docker-section" <?= $replaceDockerSection ? 'checked' : '' ?> onchange="saveSetting('replace_docker_section', this.checked ? '1' : '0')" />
        <span id="save-status-replace-docker-section" class="save-status">Saved</span>
      </div>
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <label for="distinguish-healthy">Distinguish health status</label>
        <div class="description">When enabled, running containers with a passing health check show green, and those without a health check show blue. When disabled, all running containers show green. <strong>Default: On</strong></div>
      </div>
      <div class="setting-control">
        <input type="checkbox" id="distinguish-healthy" <?= $distinguishHealthy ? 'checked' : '' ?> onchange="saveSetting('distinguish_healthy', this.checked ? '1' : '0')" />
        <span id="save-status-distinguish-healthy" class="save-status">Saved</span>
      </div>
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <label for="show-stats">Show container stats</label>
        <div class="description">When enabled, live resource stats (CPU, memory, network, etc.) are polled and displayed on container cards. Disable to reduce network traffic and server load. <strong>Default: On</strong></div>
      </div>
      <div class="setting-control">
        <input type="checkbox" id="show-stats" <?= $showStats ? 'checked' : '' ?> onchange="saveSetting('show_stats', this.checked ? '1' : '0')" />
        <span id="save-status-show-stats" class="save-status">Saved</span>
      </div>
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <label for="show-folder-ports">Show ports on collapsed folders</label>
        <div class="description">When enabled, collapsed folders display the public ports of all running containers inside them. <strong>Default: On</strong></div>
      </div>
      <div class="setting-control">
        <input type="checkbox" id="show-folder-ports" <?= $showFolderPorts ? 'checked' : '' ?> onchange="saveSetting('show_folder_ports', this.checked ? '1' : '0')" />
        <span id="save-status-show-folder-ports" class="save-status">Saved</span>
      </div>
    </div>
  </div>

  <div class="action-buttons">
    <a href="https://github.com/rizowski/unraid-docker-folders" class="btn btn-secondary" target="_blank">
      View on GitHub
    </a>
  </div>
</div>

<script>
function saveSetting(key, value) {
  var statusEl = document.getElementById('save-status-' + key.replace(/_/g, '-'));
  var csrfToken = (typeof window.csrf_token === 'string') ? window.csrf_token : '';
  var body = 'csrf_token=' + encodeURIComponent(csrfToken) + '&payload=' + encodeURIComponent(JSON.stringify({key: key, value: value}));

  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/plugins/unraid-docker-folders-modern/api/settings.php', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.onload = function() {
    if (statusEl) {
      statusEl.classList.add('visible');
      setTimeout(function() { statusEl.classList.remove('visible'); }, 2000);
    }
  };
  xhr.send(body);
}
</script>
